# highload-vk-messenger

## Содержание
  ### [1. Тема и целевая аудитория](#topic)
  ### [2. Расчет нагрузки](#load)
  ### [Список источников](#sources)

<a name="topic"></a>
## 1. Тема и целевая аудитория
### Тема
**VK мессенджер** — отдельное приложение для переписки ВКонтакте. Это удобное средство общения для тех, кто не готов отвлекаться на новости, но хочет всегда оставаться на связи.

### Целевая аудитория
#### Возраст и пол
По данным Brand Analytics [^2], это люди в возрасте 25–44 лет, 62% - женщины, 38% - мужчины.

![image](img/age.webp)

#### География
В основном трафик из СНГ, наибольше всего из России - 88.94%.
При MAU равном 87.9 млн [^1]:
- Россия - 78.17 млн
- Беларусь - 1.92 млн
- Казахстан - 1.34 млн
- Германия - 0.78 млн
- Украина - 0.7 млн
- Другие - 4.95 млн
  
![image](img/countries.jpeg)

### MVP 
1. Регистрация по номеру телефона
2. Отправка сообщений
3. Чтение чата
4. Список чатов
5. Вложения (фото/видео/голос/файлы)
6. Список контактов

### Ключевые продуктовые решения
1. Интеграция с экосистемой VK
2. Общие пользователи с VK
3. Мультиплатформенность

<a name="load"></a>
## 2. Расчет нагрузки
### Продуктовые метрики
Таблица 1 - Количество активных пользователей

| Период         | Количество пользователей |
|----------------|--------------------------|
| MAU            | 76 миллионов [^1]        |
| DAU            | 87.9 миллионов [^1]      |

VK не публиковало информацию о чатах и среднем размере хранилища пользователей, поэтому было принято решение провести опрос.  Было опрошено 10 пользователей VK мессенджера: в среднем у пользователя 58 чатов: 42 личных чата, 16 групповых чатов; среднее количествоучастников в групповых чатах - 14; Средний размер хранилища - 8.27 ГБ.

Таблица 2 - Средний размер хранилища пользователя

<table>
    <tr>
        <th>Тип</th>
        <th>Размер</th>
    </tr>
    <tr>
        <td>Аватарка</td>
        <td>Максимальный размер аватарки 5 МБ; я взял 10 случайных пользователей, в среднем у каждого по 10 аватарок, т.е. общий объем 5 * 10 = 50 МБ</td>
    </tr>
    <tr>
        <td>Информация о профиле</td>
        <td>2 КБ</td>
    </tr>
    <tr>
        <td>Личное хранилище</td>
        <td> 8.27 ГБ </td>
    </tr>
    <tr>
        <td>Итог</td>
        <td>8.28 ГБ</td>
    </tr>
</table>

Таблица 3 - Действия пользователей по типам

| Тип действия         |Среднеее количество в день |
|----------------|--------------------------|
| Отправка сообщений            | пользователи отправляют 15 млрд сообщений в сутки [^3], т.е. в среднем один пользователь отправляет 15 млрд / 76 млн = 197.37 сообщений в день       |
| Чтение сообщений | Если в среднем у пользователя 58 чатов, из которых 16 - групповые, а в групповых в среднем по 14 учатников, то в чате в среднем находится 4.59 пользователей, т.е. если в среднем отправляют 197.37 сообщений в день: 197.37 * 4.59 = 905.93 сообщений в день |
| Авторизация/регистрация           | 1    |
| Добавление пользователей в контакты | Каждый день 5.5 млн пользователей добавляют пользователей в контакты [^4], т.е. в среднем 5.5 млн / 76 млн = 0.07 добавлений в контакты в день от одного пользователя |

### Технические метрики

Для оценки соотношения типов отправленных сообщений воспользуемся данными с сайта [^7], там сказано, что из всех сообщений: с фото - 20%, с видео - 10%,с остальными типами файлов - 5%.

VK не публиковало информацию о количестве отправляемых пользователями голосовых сообщений, поэтому было принято взять статистику мессенджера Whatsapp [^8]: 7 млрд голосовых в день при 100 млрд текстовых сообщений в день, т.е. 7% от общего числа сообщений. Тогда пользователь VK мессенджера в среднем отправляет 197.37 * 0.07 =  13.82 голосовых сообщений в день.

Таблица 4 - RPS

| Тип действия | RPS | пиковый RPS (двойная нагрузка) |
|--------------|-----|------------|
| отправка сообщений| 76 млн * 197.37  / (24 * 60 * 60) = 173,612.5 | 347,225 |
| отправка сообщений с фото | 76 млн * 197.37 * 0.2 / (24 * 60 * 60) = 34,722.5 | 69,445 |
| отправка сообщений с видео | 76 млн * 197.37 * 0.1 / (24 * 60 * 60) =  17,361.25 | 34,722.5 |
| отправка голосовых сообщений | 76 млн * 13.82 / (24 * 60 * 60) = 12,156.48 | 24,312.96 |
| отправка сообщений с файлами | 76 млн * 197.37 * 0.05 / (24 * 60 * 60) = 8,680.625 | 17,361.25 |
| чтение сообщений | 76 млн * 905.93  / (24 * 60 * 60) = 796,064  | 1,592,129 |
| чтение сообщений с фото | 76 млн * 905.93 * 0.2 / (24 * 60 * 60) = 159,212 | 318,425 |
| чтение сообщений с видео | 76 млн * 905.93 * 0.1 / (24 * 60 * 60) = 79,606  | 159,212 |
| чтение голосовых сообщений | 76 млн * 13.82 * 4.59 / (24 * 60 * 60) = 55,798  | 111,596 |
| чтение сообщений с файлами | 76 млн * 905.93 * 0.05 / (24 * 60 * 60) = 39,803 | 79,606 |
|  Авторизация  | 76 млн / (24 * 60 * 60) = 879 | 1759 |
|  Добавление пользователей в контакты  | 76 млн * 0.07 / (24 * 60 * 60) = 61 | 123 |

Средння длина сообщения 10 слов [^6], cредняя длина слова 5.28 символов [^7]. В основном в VK мессенджере отправляют сообщения на русском языке, 1 символ кириллицы весит 2 байта, таким образом размер текстового сообщения:
10 слов * 5.28 букв * 2 байта = 840 б, если учесть метаданные, то размер сообщения может увеличитя до 512 Б.

Пусть средний размер отправляемой фотографии будет 5 МБ, средний размер видео 60 МБ, а остальные файлы - 10 МБ.

Битрейт голосового сообщения в VK мессенджер равен 64 Кб/с. Пусть средняя продолжительность будет 20 секунд, тогда трафик будет равен 12,156.48 * 64 Кб * 20 = 14.83 Гб/c.

 Авторизация в мессенджерах обычно требует минимального объема трафика. В среднем, процесс авторизации может занимать от 50 до 150 КБ. Этот объем включает в себя передачу учетных данных пользователя и, возможно, некоторую дополнительную информацию для обеспечения безопасности. Пусть на авторизацию будет уходить 100 КБ трафика.

Таблица 5 - Сетевой трафик

| Тип действия | Трафик, Гб/c | Пиковый трафик (двойная нагрузка), Гб/c |
|--------------|-----|------------|
| отправка сообщений | 173,612.5 * 512 Б = 0.66 | 1.32 |
|  отправка сообщений с фото |  34,722.5 * (512 Б + 5 МБ) = 1356  | 2712 |
  |отправка сообщений с видео  | 17,361.25 * (512 Б + 60 МБ) = 16'276  | 32,552 |
|отправка голосовых сообщений  | 12,156.48 * 64 Кб * 20 = 14.83 | 29 |
| отправка сообщений с файлами | 8,680.625 * (512 Б + 5 МБ) = 678 | 1356 |
| чтение сообщений |  796,064 * 512 Б = 3 | 6 |
| чтение сообщений с фото | 159,212 * (512 Б + 5 МБ) = 778 | 1556 |
| чтение голосовых сообщений | 55,798 * 64 Кб * 20 = 68  | 136 |
| чтение сообщений с файлами | 39,803 * (512 Б + 5 МБ) = 1554 | 3100 |
|  Авторизация | 879 * 100 КБ = 0.67 | 1.34 |

<a name="sources"></a>
## Источники
[^1]: [Пресс-релиз по результатам за 2 кв. и 1 пол. 2024](https://vk.company/ru/press/releases/11805/)

[^2]: [Анализ целевой аудитории VK от Demis Group](https://www.demis.ru/articles/celevaya-auditoria-vkontakte/)

[^3]: [Данные с официального сайта VK](https://vk.com/about)

[^4]: [Исследование дружбы в VK от Вконтакте 2023 года](https://vk.com/press/friends-research)

[^5]: [Анализ длины сообщений](https://www.researchgate.net/publication/299487660_WhatsApp_Usage_Patterns_and_Prediction_Models)

[^6]: [Анализ длины слов]([https://norvig.com/mayzner.html](http://lingvisto.org/artikoloj/ru_stat.html))

[^7]: [Ежегодный отчет Cisco по Интернету (2018–2023 гг.)](https://www.cisco.com/c/en/us/solutions/collateral/executive-perspectives/annual-internet-report/white-paper-c11-741490.html)

[^8] : [Статистика Whatsapp](https://www.coolest-gadgets.com/whatsapp-statistics/)
