# highload-vk-messenger

## Содержание
  ### [1. Тема и целевая аудитория](#topic)
  ### [2. Расчет нагрузки](#load)
  ### [Список источников](#sources)

<a name="topic"></a>
## 1. Тема и целевая аудитория
### Тема
**VK мессенджер** — отдельное приложение для переписки ВКонтакте. Это удобное средство общения для тех, кто не готов отвлекаться на новости, но хочет всегда оставаться на связи.

### Целевая аудитория
#### Возраст и пол
По данным Brand Analytics [^2], это люди в возрасте 25–44 лет, 62% - женщины, 38% - мужчины.

![image](img/age.webp)

MAU VK мессенджера в России равен 72.9 млн [^1], доля пользователь России - 88.94% [^11], т.е. глобальный MAU VK мессенджера равен 72.9 млн / 0.8894 = 81.96 млн.

#### География
В основном трафик из СНГ, наибольше всего из России - 88.94%.
При MAU равном 81.96 млн [^1]:
- Россия - 72.9 млн
- Беларусь - 1.8 млн
- Казахстан - 1.25 млн
- Германия - 0.73 млн
- Украина - 0.65 млн
- Другие - 4.62 млн
  
![image](img/countries.jpeg)

### MVP 
1. Регистрация по номеру телефона
2. Отправка сообщений
3. Чтение чата
4. Список чатов
5. Вложения (фото/видео/голос/файлы)
6. Список контактов

### Ключевые продуктовые решения
1. Интеграция с экосистемой VK
2. Общие пользователи с VK
3. Мультиплатформенность

<a name="load"></a>
## 2. Расчет нагрузки
### Продуктовые метрики

Метрики соцсети VK: DAU - 77 млн, MAU - 87,9 млн [^1], т.е. 87.6% ежемесячных пользователей заходят каждый день. 
Пользователи VK мессенджер являются частью пользователей соцсети VK, следовательно их поведение не должно сильно отличатся от пользователей соцсети VK, тогда DAU VK мессенджера равна 81.96 млн * 87.6% = 71.8 млн

Таблица 1 - Количество активных пользователей

| Период         | Количество пользователей |
|----------------|--------------------------|
| MAU            | 81.96 млн     |
| DAU            | 71.8 млн      |

VK не публиковало информацию о чатах и среднем размере хранилища пользователей, поэтому было принято решение провести опрос.  Было опрошено 10 пользователей VK мессенджера: в среднем у пользователя 58 чатов: 42 личных чата, 16 групповых чатов; среднее количествоучастников в групповых чатах - 14; Средний размер хранилища - 8.27 ГБ.

Таблица 2 - Средний размер хранилища пользователя

<table>
    <tr>
        <th>Тип</th>
        <th>Размер</th>
    </tr>
    <tr>
        <td>Аватарка</td>
        <td>Максимальный размер аватарки 5 МБ; я взял 10 случайных пользователей, в среднем у каждого по 10 аватарок, т.е. общий объем 5 * 10 = 50 МБ</td>
    </tr>
    <tr>
        <td>Информация о профиле</td>
        <td>2 КБ</td>
    </tr>
    <tr>
        <td>Личное хранилище</td>
        <td> 8.27 ГБ </td>
    </tr>
    <tr>
        <td>Итог</td>
        <td>8.28 ГБ</td>
    </tr>
</table>

Таблица 3 - Действия пользователей по типам

| Тип действия         |Среднеее количество в день |
|----------------|--------------------------|
| Отправка сообщений            | пользователи отправляют 15 млрд сообщений в сутки [^3], т.е. в среднем один пользователь отправляет 15 млрд / 71.8 млн = 197.37 сообщений в день       |
| Чтение сообщений | Если в среднем у пользователя 58 чатов, из которых 16 - групповые, а в групповых в среднем по 14 учатников, то в чате в среднем находится 4.59 пользователей. пользователь, отправивший сообщение в групповом чате очень редко будет его скачивать с сервера, поэтому поэтому получать, в среднем, будут 4.59 - 1 = 3.59 пользователей, т.е. если в среднем отправляют 197.37 сообщений в день: 197.37 * 3.59 = 708.56 сообщений в день |
| Авторизация/регистрация           | Данная метрика не в VK мессенджере не публиковалась, в Whatsapp заходят 14.4 раз в день[^12]   |
| Добавление пользователей в контакты | Каждый день 5.5 млн пользователей добавляют пользователей в контакты [^4], т.е. в среднем 5.5 млн / 76 млн = 0.07 добавлений в контакты в день от одного пользователя |

### Технические метрики

Для оценки соотношения типов отправленных сообщений воспользуемся данными с сайта [^7], там сказано, что из всех сообщений: с фото - 20%, с видео - 10%,с остальными типами файлов - 5%.

VK не публиковало информацию о количестве отправляемых пользователями голосовых сообщений, поэтому было принято взять статистику мессенджера Whatsapp [^8]: 7 млрд голосовых в день при 100 млрд текстовых сообщений в день, т.е. 7% от общего числа сообщений. Тогда пользователь VK мессенджера в среднем отправляет 197.37 * 0.07 =  13.82 голосовых сообщений в день.

Таблица 4 - RPS

| Тип действия | RPS | пиковый RPS (двойная нагрузка) |
|--------------|-----|------------|
| отправка сообщений| 71.8 млн * 197.37  / (24 * 60 * 60) = 164,018 | 328,225 |
| отправка сообщений с фото | 71.8 млн * 197.37 * 0.2 / (24 * 60 * 60) = 32,803 | 65,607 |
| отправка сообщений с видео | 71.8 млн * 197.37 * 0.1 / (24 * 60 * 60) =  16,401 | 32,803 |
| отправка голосовых сообщений | 71.8 млн * 13.82 / (24 * 60 * 60) = 11,484 | 22,969 |
| отправка сообщений с файлами | 71.8 млн * 197.37 * 0.05 / (24 * 60 * 60) = 8,200 | 16,400 |
| чтение сообщений | 71.8 млн * 708.56  / (24 * 60 * 60) = 588,826  | 1,177,652 |
| чтение сообщений с фото | 71.8 млн * 708.56 * 0.2 / (24 * 60 * 60) = 117,765 | 235,530 |
| чтение сообщений с видео | 71.8 млн * 708.56 * 0.1 / (24 * 60 * 60) = 58,882  | 117,765 |
| чтение голосовых сообщений | 71.8 млн * 13.82 * 4.59 / (24 * 60 * 60) = 52,714  | 105,429 |
| чтение сообщений с файлами | 71.8 млн * 708.56 * 0.05 / (24 * 60 * 60) = 29,441 | 58,882 |
|  Авторизация  | 71.8 млн * 14.4 / (24 * 60 * 60) = 11,966 | 23,933 |
|  Добавление пользователей в контакты  | 71.8 млн * 0.07 / (24 * 60 * 60) = 58 | 116 |

Средння длина сообщения 10 слов [^6], cредняя длина слова 5.28 символов [^7]. В основном в VK мессенджере отправляют сообщения на русском языке, 1 символ кириллицы весит 2 байта, таким образом размер текстового сообщения:
10 слов * 5.28 букв * 2 байта = 840 б, если учесть метаданные, то размер сообщения может увеличитя до 512 Б.

Пусть средний размер отправляемой фотографии будет 5 МБ, средний размер видео 60 МБ, а остальные файлы - 10 МБ.

Битрейт голосового сообщения в VK мессенджер равен 64 Кб/с. Пусть средняя продолжительность будет 20 секунд, тогда трафик будет равен 12,156.48 * 64 Кб * 20 = 14.83 Гб/c.

 Авторизация в мессенджерах обычно требует минимального объема трафика. В среднем, процесс авторизации может занимать от 50 до 150 КБ. Этот объем включает в себя передачу учетных данных пользователя и, возможно, некоторую дополнительную информацию для обеспечения безопасности. Пусть на авторизацию будет уходить 100 КБ трафика.

Таблица 5 - Сетевой трафик

| Тип действия | Трафик, Гб/c | Пиковый трафик (двойная нагрузка), Гб/c |
|--------------|-----|------------|
| отправка сообщений | 173,612.5 * 512 Б = 0.66 | 1.32 |
|  отправка сообщений с фото |  34,722.5 * (512 Б + 5 МБ) = 1356  | 2,712 |
  |отправка сообщений с видео  | 17,361.25 * (512 Б + 60 МБ) = 16,276  | 32,552 |
|отправка голосовых сообщений  | 12,156.48 * 64 Кб * 20 = 14.83 | 29 |
| отправка сообщений с файлами | 8,680.625 * (512 Б + 5 МБ) = 678 | 1,356 |
| чтение сообщений |  796,064 * 512 Б = 3 | 6 |
| чтение сообщений с фото | 159,212 * (512 Б + 5 МБ) = 778 | 1,556 |
| чтение голосовых сообщений | 55,798 * 64 Кб * 20 = 68  | 136 |
| чтение сообщений с файлами | 39,803 * (512 Б + 5 МБ) = 1554 | 3,100 |
|  Авторизация | 879 * 100 КБ = 0.67 | 1.34 |


Для подсчета сжатия фото я загрузил 10 фото размером 5 МБ в VK мессенджер, средний процент сжатия составил 87%, т.е. объем сжатого фото составляет 13% от исходного.

VK использует видеокодек AV1 [^9], он сжимает в среднем на 50% от изначального объема видео [^10]. 

Таблица 6 - Основное хранилище

| Тип данных | Объем, ПБ |
|------------|-----------|
| Данные пользователей | 8.28 ГБ * 87.9 млн = 694 |

Таблица 7 - Рост хранилища

| Тип данных | Объем в день, ПБ | Объем в месяц, ПБ |
|------------|--------------|---------------|
| Текст | 0.66 Гб/c * 24ч * 60м * 60с = 0.007 | 0.21 |
| Фото | 1,356 Гб/c * 24ч * 60м * 60с * 0.13 = 1.82 | 54.6 |
| Видео | 16,276 Гб/c * 24ч * 60м * 60с * 0.5 = 83.81 | 2,514.3 |
| Голосовые | 14.83 Гб/c * 24ч * 60м * 60с = 0.15 | 4.5 |
| Прочие файлы | 678 Гб/c * 24ч * 60м * 60с = 6.98 |209.4  |
| Итог | 78.49 | 2,354.7 |


<a name="sources"></a>
## Источники
[^1]: [Пресс-релиз по результатам за 2 кв. и 1 пол. 2024](https://vk.company/ru/press/releases/11805/)

[^2]: [Анализ целевой аудитории VK от Demis Group](https://www.demis.ru/articles/celevaya-auditoria-vkontakte/)

[^3]: [Данные с официального сайта VK](https://vk.com/about)

[^4]: [Исследование дружбы в VK от Вконтакте 2023 года](https://vk.com/press/friends-research)

[^5]: [Анализ длины сообщений](https://www.researchgate.net/publication/299487660_WhatsApp_Usage_Patterns_and_Prediction_Models)

[^6]: [Анализ длины слов]([https://norvig.com/mayzner.html](http://lingvisto.org/artikoloj/ru_stat.html))

[^7]: [Ежегодный отчет Cisco по Интернету (2018–2023 гг.)](https://www.cisco.com/c/en/us/solutions/collateral/executive-perspectives/annual-internet-report/white-paper-c11-741490.html)

[^8]: [Статистика Whatsapp](https://www.coolest-gadgets.com/whatsapp-statistics/)

[^9]: [Видеокодек VK](https://www.forbes.ru/tekhnologii/520576-zakodirovat-ot-lisnego-vesa-vk-vlozila-100-mln-rublej-v-tehnologiu-szatia-video)

[^10]: [Официальный сайт aomedia](https://aomedia.org/)

[^11]: [Анализ vk.com от similarweb](https://www.similarweb.com/ru/website/vk.com/#overview)

[^12]: [Анализ мессенджеров от tadviser](https://www.tadviser.ru/index.php/%D0%A1%D1%82%D0%B0%D1%82%D1%8C%D1%8F:%D0%9C%D0%B5%D1%81%D1%81%D0%B5%D0%BD%D0%B4%D0%B6%D0%B5%D1%80%D1%8B_(Instant_Messenger,_IM))
